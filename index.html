<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Service Report</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to compile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- Predefined Options for Dropdowns ---
        const hvacMakes = ["Carrier", "Goodman", "Trane", "Lennox", "York", "Rheem", "Ruud", "Amana", "Bryant", "Heil", "Payne", "Daikin", "Other"];
        const unitTypes = ["Rooftop Unit (RTU)", "Air Handling Unit (AHU)", "Split System", "Furnace", "Boiler", "Heat Pump", "Ductless Mini-Split", "EF Exhaust Fan", "VAV Variable Air Volume", "Other"];
        const locations = ["Rooftop", "Basement", "Mechanical Room", "Closet", "Attic", "Exterior Wall", "Crawlspace", "Other"];
        const areasServed = ["First Floor", "Second Floor", "Office Area", "Warehouse", "Lobby", "Conference Room", "Server Room", "Kitchen", "Whole Building", "Other"];
        const unitNumbers = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "N/A"];
        const filterSizes = ["16x20x1", "16x25x1", "20x20x1", "20x25x1", "20x20x2", "20x25x2", "24x24x2", "Custom"];
        const beltSizes = ["AX-34", "AX-35", "AX-36", "BX-45", "BX-46", "BX-47", "4L350", "4L360", "4L370", "Custom"];
        const punchListItems = [
            "Fill out HVAC Survery Sheet In Full: Make, Model, Serial, Age, Tonnage, Area Served, and Condition",
            "Replace air filters",
            "Clean condensate drain",
            "Lubricate blower shaft bearings",
            "Inspect belts",
            "Check refrigerant charge",
            "Check program and thermostat operation",
            "Check evaporator and condenser coils",
            "Inspect blower motor mounts",
            "Lubricate blower motor bearings",
            "Lubricate evaporator / fan motor",
            "Test high/low pressure control operation"
        ];


        // Helper to convert file to base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // UnitCard Component
        const UnitCard = ({ unit, onUpdate, onDelete, onGeneratePdf }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editedUnit, setEditedUnit] = useState(unit);
            const fileInputRef = useRef(null);
            const cameraInputRef = useRef(null);

            const handleImageUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                const base64Images = await Promise.all(files.map(file => toBase64(file)));
                const newImages = [...editedUnit.images, ...base64Images];
                const updatedUnit = { ...editedUnit, images: newImages };
                setEditedUnit(updatedUnit);
                onUpdate(updatedUnit.id, updatedUnit);
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setEditedUnit({ ...editedUnit, [name]: value });
            };
            
            const handlePunchListChange = (item) => {
                setEditedUnit(prev => ({
                    ...prev,
                    punchList: {
                        ...prev.punchList,
                        [item]: !prev.punchList[item]
                    }
                }));
            };

            const handleToggleAllPunchList = () => {
                const allChecked = punchListItems.every(item => editedUnit.punchList[item]);
                const newPunchList = {};
                punchListItems.forEach(item => {
                    newPunchList[item] = !allChecked;
                });
                setEditedUnit(prev => ({ ...prev, punchList: newPunchList }));
            };

            const handleEconomizerChange = (e) => {
                setEditedUnit({ ...editedUnit, economizer: e.target.value === 'yes' });
            };
            
            const handleFilterChange = (index, event) => {
                const { name, value } = event.target;
                const newFilters = [...editedUnit.filters];
                newFilters[index][name] = value;
                setEditedUnit({ ...editedUnit, filters: newFilters });
            };
            
            const handleBeltChange = (index, event) => {
                const { name, value } = event.target;
                const newBelts = [...editedUnit.belts];
                newBelts[index][name] = value;
                setEditedUnit({ ...editedUnit, belts: newBelts });
            };

            const addFilterField = () => {
                const newFilters = [...(editedUnit.filters || []), { size: '', quantity: '' }];
                setEditedUnit({ ...editedUnit, filters: newFilters });
            };

            const addBeltField = () => {
                const newBelts = [...(editedUnit.belts || []), { size: '', quantity: '' }];
                setEditedUnit({ ...editedUnit, belts: newBelts });
            };

            const removeFilterField = (index) => {
                const newFilters = [...editedUnit.filters];
                newFilters.splice(index, 1);
                setEditedUnit({ ...editedUnit, filters: newFilters });
            };
            
            const removeBeltField = (index) => {
                const newBelts = [...editedUnit.belts];
                newBelts.splice(index, 1);
                setEditedUnit({ ...editedUnit, belts: newBelts });
            };

            const handleSaveChanges = () => {
                const finalFilters = editedUnit.filters ? editedUnit.filters.filter(f => f.size && f.quantity) : [];
                const finalBelts = editedUnit.belts ? editedUnit.belts.filter(b => b.size && b.quantity) : [];
                onUpdate(editedUnit.id, {...editedUnit, filters: finalFilters, belts: finalBelts});
                setIsEditing(false);
            };

            const handleRemoveImage = (index) => {
                const newImages = editedUnit.images.filter((_, i) => i !== index);
                const updatedUnit = { ...editedUnit, images: newImages };
                setEditedUnit(updatedUnit);
                onUpdate(updatedUnit.id, updatedUnit);
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-lg mb-6 border border-gray-200">
                    {!isEditing ? (
                        <div>
                            <h3 className="text-xl font-bold text-gray-800 mb-4">Unit #{unit.unitNumber || 'N/A'}: {unit.location}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                                <p><strong className="font-semibold">Make:</strong> {unit.make}</p>
                                <p><strong className="font-semibold">Unit Type:</strong> {unit.unitType}</p>
                                <p><strong className="font-semibold">Area Served:</strong> {unit.areaServed}</p>
                                <p><strong className="font-semibold">Model #:</strong> {unit.modelNumber}</p>
                                <p><strong className="font-semibold">Serial #:</strong> {unit.serialNumber}</p>
                                <p><strong className="font-semibold">Drive Type:</strong> {unit.driveType === 'dd' ? 'Direct Drive' : 'Belt Drive'}</p>
                                <p><strong className="font-semibold">Economizer:</strong> {unit.economizer ? 'Yes' : 'No'}</p>
                            </div>
                            {unit.filters && unit.filters.length > 0 && (
                                <div className="mt-4">
                                    <h4 className="font-semibold text-gray-700">Filters:</h4>
                                    <ul className="list-disc list-inside ml-4">{unit.filters.map((filter, index) => (<li key={index}>{filter.quantity}x - {filter.size}</li>))}</ul>
                                </div>
                            )}
                            {unit.belts && unit.belts.length > 0 && (
                                <div className="mt-4">
                                    <h4 className="font-semibold text-gray-700">Belts:</h4>
                                    <ul className="list-disc list-inside ml-4">{unit.belts.map((belt, index) => (<li key={index}>{belt.quantity}x - {belt.size}</li>))}</ul>
                                </div>
                            )}
                            {unit.punchList && Object.values(unit.punchList).some(v => v) && (
                                <div className="mt-4">
                                    <h4 className="font-semibold text-gray-700">Punch List Completed:</h4>
                                    <ul className="list-disc list-inside ml-4">{punchListItems.map((item, index) => (unit.punchList[item] && <li key={index}>{item}</li>))}</ul>
                                </div>
                            )}
                             {unit.notes && (<div className="mt-4"><h4 className="font-semibold text-gray-700">Notes:</h4><p className="text-gray-600 whitespace-pre-wrap bg-gray-50 p-3 rounded-md">{unit.notes}</p></div>)}
                            <div className="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">{unit.images.map((image, index) => (<div key={index} className="relative"><img src={image} alt={`Unit ${index + 1}`} className="rounded-md object-cover w-full h-32" /></div>))}</div>
                            <div className="mt-6 flex justify-end space-x-3">
                                <button onClick={() => onGeneratePdf(unit)} className="px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 transition">Generate Unit PDF</button>
                                <button onClick={() => setIsEditing(true)} className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">Edit</button>
                                <button onClick={() => onDelete(unit.id)} className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">Delete</button>
                            </div>
                        </div>
                    ) : (
                        <div>
                            <h3 className="text-xl font-bold text-gray-800 mb-4">Editing Unit</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <select name="unitNumber" value={editedUnit.unitNumber} onChange={handleInputChange} className="p-2 border rounded-md"><option value="">Unit Number</option>{unitNumbers.map(n => <option key={n} value={n}>{n}</option>)}</select>
                                <select name="unitType" value={editedUnit.unitType} onChange={handleInputChange} className="p-2 border rounded-md"><option value="">Unit Type</option>{unitTypes.map(t => <option key={t} value={t}>{t}</option>)}</select>
                                <select name="location" value={editedUnit.location} onChange={handleInputChange} className="p-2 border rounded-md"><option value="">Location</option>{locations.map(l => <option key={l} value={l}>{l}</option>)}</select>
                                <select name="areaServed" value={editedUnit.areaServed} onChange={handleInputChange} className="p-2 border rounded-md"><option value="">Area Served</option>{areasServed.map(a => <option key={a} value={a}>{a}</option>)}</select>
                                <select name="make" value={editedUnit.make} onChange={handleInputChange} className="p-2 border rounded-md"><option value="">Make</option>{hvacMakes.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                <input type="text" name="modelNumber" value={editedUnit.modelNumber} onChange={handleInputChange} placeholder="Model Number" className="p-2 border rounded-md" />
                                <input type="text" name="serialNumber" value={editedUnit.serialNumber} onChange={handleInputChange} placeholder="Serial Number" className="p-2 border rounded-md" />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <select name="driveType" value={editedUnit.driveType} onChange={handleInputChange} className="p-2 border rounded-md"><option value="belt">Belt Drive</option><option value="dd">Direct Drive</option></select>
                                <div className="flex items-center space-x-4"><label className="font-medium">Economizer:</label><label><input type="radio" value="yes" checked={editedUnit.economizer === true} onChange={handleEconomizerChange} className="mr-1"/>Yes</label><label><input type="radio" value="no" checked={editedUnit.economizer === false} onChange={handleEconomizerChange} className="mr-1"/>No</label></div>
                            </div>
                            <div className="mt-4">
                                <h4 className="font-semibold text-gray-700 mb-2">Filters</h4>
                                {editedUnit.filters.map((filter, index) => (
                                    <div key={index} className="flex items-center space-x-2 mb-2">
                                        <input list="filter-sizes" name="size" value={filter.size} onChange={e => handleFilterChange(index, e)} placeholder="Filter Size" className="p-2 border rounded-md w-1/2" />
                                        <datalist id="filter-sizes">{filterSizes.map(s => <option key={s} value={s}/>)}</datalist>
                                        <input type="number" name="quantity" value={filter.quantity} onChange={e => handleFilterChange(index, e)} placeholder="Qty" className="p-2 border rounded-md w-1/4" />
                                        <button onClick={() => removeFilterField(index)} className="px-3 py-2 bg-red-500 text-white rounded-md">&times;</button>
                                    </div>
                                ))}
                                <button onClick={addFilterField} className="text-sm text-blue-500 hover:underline">+ Add Filter</button>
                            </div>
                             <div className="mt-4">
                                <h4 className="font-semibold text-gray-700 mb-2">Belts</h4>
                                {editedUnit.belts.map((belt, index) => (
                                    <div key={index} className="flex items-center space-x-2 mb-2">
                                        <input list="belt-sizes" name="size" value={belt.size} onChange={e => handleBeltChange(index, e)} placeholder="Belt Size" className="p-2 border rounded-md w-1/2" />
                                        <datalist id="belt-sizes">{beltSizes.map(s => <option key={s} value={s}/>)}</datalist>
                                        <input type="number" name="quantity" value={belt.quantity} onChange={e => handleBeltChange(index, e)} placeholder="Qty" className="p-2 border rounded-md w-1/4" />
                                        <button onClick={() => removeBeltField(index)} className="px-3 py-2 bg-red-500 text-white rounded-md">&times;</button>
                                    </div>
                                ))}
                                <button onClick={addBeltField} className="text-sm text-blue-500 hover:underline">+ Add Belt</button>
                            </div>
                            <div className="mt-4">
                                <div className="flex justify-between items-center mb-2">
                                    <h4 className="font-semibold text-gray-700">Punch List</h4>
                                    <button type="button" onClick={handleToggleAllPunchList} className="text-sm text-blue-500 hover:underline">
                                        {punchListItems.every(item => editedUnit.punchList[item]) ? 'Uncheck All' : 'Check All'}
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    {punchListItems.map((item, index) => (
                                        <label key={index} className="flex items-center space-x-2">
                                            <input type="checkbox" checked={!!editedUnit.punchList[item]} onChange={() => handlePunchListChange(item)} />
                                            <span>{item}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                            <div className="mt-4"><h4 className="font-semibold text-gray-700 mb-2">Notes</h4><textarea name="notes" value={editedUnit.notes} onChange={handleInputChange} placeholder="Service notes..." className="p-2 border rounded-md w-full h-24"></textarea></div>
                            <div className="mt-4 grid grid-cols-2 gap-2"><button onClick={() => fileInputRef.current.click()} className="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Upload Pictures</button><button onClick={() => cameraInputRef.current.click()} className="w-full px-4 py-2 bg-blue-200 text-blue-800 rounded-md hover:bg-blue-300 transition">Open Camera</button><input type="file" multiple accept="image/*" ref={fileInputRef} className="hidden" onChange={handleImageUpload} /><input type="file" accept="image/*" capture="environment" ref={cameraInputRef} className="hidden" onChange={handleImageUpload} /></div>
                            <div className="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">{editedUnit.images.map((image, index) => (<div key={index} className="relative"><img src={image} alt={`Unit ${index + 1}`} className="rounded-md object-cover w-full h-32" /><button onClick={() => handleRemoveImage(index)} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 text-xs">&times;</button></div>))}</div>
                            <div className="mt-6 flex justify-end"><button onClick={handleSaveChanges} className="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">Save Changes</button></div>
                        </div>
                    )}
                </div>
            );
        };

        // UnitForm Component
        const UnitForm = ({ onAddUnit }) => {
            const [unitNumber, setUnitNumber] = useState('');
            const [unitType, setUnitType] = useState('');
            const [location, setLocation] = useState('');
            const [areaServed, setAreaServed] = useState('');
            const [make, setMake] = useState('');
            const [modelNumber, setModelNumber] = useState('');
            const [serialNumber, setSerialNumber] = useState('');
            const [notes, setNotes] = useState('');
            const [images, setImages] = useState([]);
            const [filters, setFilters] = useState([{ size: '', quantity: '' }]);
            const [belts, setBelts] = useState([{ size: '', quantity: '' }]);
            const [punchList, setPunchList] = useState(() => punchListItems.reduce((acc, item) => ({...acc, [item]: false }), {}));
            const [driveType, setDriveType] = useState('belt');
            const [economizer, setEconomizer] = useState('no');
            const fileInputRef = useRef(null);
            const cameraInputRef = useRef(null);

            const handleImageUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                const base64Images = await Promise.all(files.map(file => toBase64(file)));
                setImages(prevImages => [...prevImages, ...base64Images]);
            };

            const handleFilterChange = (index, event) => {
                const { name, value } = event.target;
                const newFilters = [...filters];
                newFilters[index][name] = value;
                setFilters(newFilters);
            };

            const handleBeltChange = (index, event) => {
                const { name, value } = event.target;
                const newBelts = [...belts];
                newBelts[index][name] = value;
                setBelts(newBelts);
            };

            const handlePunchListChange = (item) => {
                setPunchList(prev => ({ ...prev, [item]: !prev[item] }));
            };

            const handleToggleAllPunchList = () => {
                const allChecked = punchListItems.every(item => punchList[item]);
                const newPunchList = {};
                punchListItems.forEach(item => {
                    newPunchList[item] = !allChecked;
                });
                setPunchList(newPunchList);
            };

            const addFilterField = () => {
                setFilters([...filters, { size: '', quantity: '' }]);
            };
            
            const addBeltField = () => {
                setBelts([...belts, { size: '', quantity: '' }]);
            };

            const removeFilterField = (index) => {
                const newFilters = [...filters];
                newFilters.splice(index, 1);
                setFilters(newFilters);
            };
            
            const removeBeltField = (index) => {
                const newBelts = [...belts];
                newBelts.splice(index, 1);
                setBelts(newBelts);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!location) {
                    alert("Please provide a location for the unit.");
                    return;
                }
                const finalFilters = filters.filter(f => f.size && f.quantity);
                const finalBelts = belts.filter(b => b.size && b.quantity);
                onAddUnit({ id: Date.now(), unitNumber, unitType, location, areaServed, make, modelNumber, serialNumber, images, filters: finalFilters, belts: finalBelts, driveType, economizer: economizer === 'yes', notes, punchList });
                setUnitNumber(''); setUnitType(''); setLocation(''); setAreaServed(''); setMake(''); setModelNumber(''); setSerialNumber(''); setNotes(''); setImages([]); setFilters([{ size: '', quantity: '' }]); setBelts([{ size: '', quantity: '' }]); setDriveType('belt'); setEconomizer('no'); setPunchList(punchListItems.reduce((acc, item) => ({...acc, [item]: false }), {}));
            };
            
            const handleRemoveImage = (index) => {
                setImages(images.filter((_, i) => i !== index));
            };

            return (
                <div className="bg-white p-8 rounded-xl shadow-2xl mb-8 border border-gray-200">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Add New HVAC Unit</h2>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <select value={unitNumber} onChange={(e) => setUnitNumber(e.target.value)} className="p-3 border rounded-lg"><option value="">Select Unit Number</option>{unitNumbers.map(n => <option key={n} value={n}>{n}</option>)}</select>
                            <select value={unitType} onChange={(e) => setUnitType(e.target.value)} className="p-3 border rounded-lg"><option value="">Select Unit Type</option>{unitTypes.map(t => <option key={t} value={t}>{t}</option>)}</select>
                            <select value={location} onChange={(e) => setLocation(e.target.value)} className="p-3 border rounded-lg" required><option value="">Select Location</option>{locations.map(l => <option key={l} value={l}>{l}</option>)}</select>
                            <select value={areaServed} onChange={(e) => setAreaServed(e.target.value)} className="p-3 border rounded-lg"><option value="">Select Area Served</option>{areasServed.map(a => <option key={a} value={a}>{a}</option>)}</select>
                            <select value={make} onChange={(e) => setMake(e.target.value)} className="p-3 border rounded-lg"><option value="">Select Make</option>{hvacMakes.map(m => <option key={m} value={m}>{m}</option>)}</select>
                            <input type="text" placeholder="Model Number" value={modelNumber} onChange={(e) => setModelNumber(e.target.value)} className="p-3 border rounded-lg" />
                            <input type="text" placeholder="Serial Number" value={serialNumber} onChange={(e) => setSerialNumber(e.target.value)} className="p-3 border rounded-lg" />
                        </div>
                         <textarea placeholder="Notes about the unit..." value={notes} onChange={(e) => setNotes(e.target.value)} className="p-3 border rounded-lg w-full h-28"></textarea>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <select value={driveType} onChange={(e) => setDriveType(e.target.value)} className="p-3 border rounded-lg"><option value="belt">Belt Drive</option><option value="dd">Direct Drive</option></select>
                            <div className="flex items-center space-x-4 p-3"><label className="font-medium">Economizer:</label><label><input type="radio" value="yes" checked={economizer === 'yes'} onChange={(e) => setEconomizer(e.target.value)} className="mr-1"/>Yes</label><label><input type="radio" value="no" checked={economizer === 'no'} onChange={(e) => setEconomizer(e.target.value)} className="mr-1"/>No</label></div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Filters</label>
                            {filters.map((filter, index) => (
                                <div key={index} className="flex items-center space-x-2 mb-2">
                                    <input list="filter-sizes" name="size" value={filter.size} onChange={e => handleFilterChange(index, e)} placeholder="Filter Size (e.g., 20x20x1)" className="p-3 border rounded-lg w-full md:w-1/2" />
                                    <input type="number" name="quantity" value={filter.quantity} onChange={e => handleFilterChange(index, e)} placeholder="Qty" className="p-3 border rounded-lg w-full md:w-1/4" />
                                    <button type="button" onClick={() => removeFilterField(index)} className="px-3 py-2 bg-red-200 text-red-800 rounded-lg hover:bg-red-300">-</button>
                                </div>
                            ))}
                            <datalist id="filter-sizes">{filterSizes.map(s => <option key={s} value={s}/>)}</datalist>
                            <button type="button" onClick={addFilterField} className="mt-1 text-sm text-blue-600 hover:underline">+ Add another filter size</button>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Belts</label>
                            {belts.map((belt, index) => (
                                <div key={index} className="flex items-center space-x-2 mb-2">
                                    <input list="belt-sizes" name="size" value={belt.size} onChange={e => handleBeltChange(index, e)} placeholder="Belt Size (e.g., AX-34)" className="p-3 border rounded-lg w-full md:w-1/2" />
                                    <input type="number" name="quantity" value={belt.quantity} onChange={e => handleBeltChange(index, e)} placeholder="Qty" className="p-3 border rounded-lg w-full md:w-1/4" />
                                    <button type="button" onClick={() => removeBeltField(index)} className="px-3 py-2 bg-red-200 text-red-800 rounded-lg hover:bg-red-300">-</button>
                                </div>
                            ))}
                            <datalist id="belt-sizes">{beltSizes.map(s => <option key={s} value={s}/>)}</datalist>
                            <button type="button" onClick={addBeltField} className="mt-1 text-sm text-blue-600 hover:underline">+ Add another belt size</button>
                        </div>
                         <div>
                            <div className="flex justify-between items-center mb-2">
                                <label className="block text-lg font-medium text-gray-700">Punch List</label>
                                <button type="button" onClick={handleToggleAllPunchList} className="text-sm text-blue-600 hover:underline">
                                    {punchListItems.every(item => punchList[item]) ? 'Uncheck All' : 'Check All'}
                                </button>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2">
                                {punchListItems.map((item, index) => (
                                    <label key={index} className="flex items-center space-x-3">
                                        <input type="checkbox" checked={punchList[item]} onChange={() => handlePunchListChange(item)} className="h-4 w-4"/>
                                        <span className="text-gray-700">{item}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-2"><button type="button" onClick={() => fileInputRef.current.click()} className="w-full px-4 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Upload Pictures</button><button type="button" onClick={() => cameraInputRef.current.click()} className="w-full px-4 py-3 bg-blue-200 text-blue-800 rounded-lg hover:bg-blue-300 transition">Open Camera</button><input type="file" multiple accept="image/*" ref={fileInputRef} className="hidden" onChange={handleImageUpload} /><input type="file" accept="image/*" capture="environment" ref={cameraInputRef} className="hidden" onChange={handleImageUpload} /></div>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">{images.map((image, index) => (<div key={index} className="relative"><img src={image} alt={`upload-preview ${index}`} className="rounded-md object-cover w-full h-32" /><button type="button" onClick={() => handleRemoveImage(index)} className="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 text-xs leading-none">&times;</button></div>))}</div>
                        <button type="submit" className="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Add Unit</button>
                    </form>
                </div>
            );
        };

        // ServiceReport Component - Now with enhanced styling for a professional look
        const ServiceReport = ({ units, clientInfo }) => {
            return (
                <div id="service-report" className="p-8 bg-white font-sans" style={{width: '210mm'}}>
                    <header className="flex justify-between items-start pb-4 border-b-2 border-blue-800">
                        <div>
                           <img src="https://lh3.googleusercontent.com/a/ACg8ocJV2x6I8rQLe7Z2reDr7C7mIOmtcnYBZ6SjSKGJVvX2td0b2-4Glw=s288-c-no" alt="Company Logo" className="h-20" />
                            <p className="text-md text-gray-600 mt-2">23093 Telegraph Rd, Southfield, MI 48033</p>
                        </div>
                        <div className="text-right">
                            <h1 className="text-4xl font-extrabold text-blue-800">Service Report</h1>
                            <p className="font-bold text-gray-700 mt-2">Date: <span className="font-normal">{new Date().toLocaleDateString()}</span></p>
                            <p className="font-bold text-gray-700">Work Order #: <span className="font-normal">{clientInfo.workOrderNumber || 'N/A'}</span></p>
                        </div>
                    </header>
                    <div className="my-6 p-4 bg-gray-50 rounded-lg border">
                        <h2 className="text-xl font-bold text-gray-800 mb-2 border-b pb-1">Client Information</h2>
                        <p className="font-semibold">{clientInfo.name}</p>
                        <p className="text-gray-700">{clientInfo.address}</p>
                    </div>
                    {units.map(unit => (
                        <div key={unit.id} className="mb-8 break-inside-avoid">
                            <h3 className="text-2xl font-bold text-white bg-blue-700 p-3 rounded-t-lg">Unit #{unit.unitNumber || 'N/A'}: {unit.unitType}</h3>
                            <div className="border-l border-r border-b p-4 rounded-b-lg">
                                <h4 className="text-lg font-bold text-gray-800 mb-2">Unit Details</h4>
                                <div className="grid grid-cols-2 gap-x-8 gap-y-2 mb-4 text-sm">
                                    <p><strong className="font-semibold text-gray-600">Make:</strong> {unit.make}</p>
                                    <p><strong className="font-semibold text-gray-600">Unit Type:</strong> {unit.unitType}</p>
                                    <p><strong className="font-semibold text-gray-600">Area Served:</strong> {unit.areaServed}</p>
                                    <p><strong className="font-semibold text-gray-600">Model #:</strong> {unit.modelNumber}</p>
                                    <p><strong className="font-semibold text-gray-600">Serial #:</strong> {unit.serialNumber}</p>
                                    <p><strong className="font-semibold text-gray-600">Location #:</strong> {unit.location}</p>
                                    <p><strong className="font-semibold text-gray-600">Drive Type:</strong> {unit.driveType === 'dd' ? 'Direct Drive' : 'Belt Drive'}</p>
                                    <p><strong className="font-semibold text-gray-600">Economizer:</strong> {unit.economizer ? 'Yes' : 'No'}</p>
                                </div>
                                <div className="grid grid-cols-2 gap-8">
                                    {unit.filters && unit.filters.length > 0 && (<div><h4 className="font-bold text-gray-800">Filters:</h4><ul className="list-disc list-inside ml-1">{unit.filters.map((filter, index) => (<li key={index}>{filter.quantity}x - {filter.size}</li>))}</ul></div>)}
                                    {unit.belts && unit.belts.length > 0 && (<div><h4 className="font-bold text-gray-800">Belts:</h4><ul className="list-disc list-inside ml-1">{unit.belts.map((belt, index) => (<li key={index}>{belt.quantity}x - {belt.size}</li>))}</ul></div>)}
                                </div>
                                {unit.punchList && Object.values(unit.punchList).some(v => v) && (
                                    <div className="mt-4"><h4 className="text-lg font-bold text-gray-800 mb-2">Punch List Completed:</h4>
                                    <ul className="grid grid-cols-2 gap-x-8 gap-y-1 text-sm">
                                        {punchListItems.map((item, index) => (unit.punchList[item] && <li key={index} className="flex items-center"><svg className="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"></path></svg>{item}</li>))}
                                    </ul></div>
                                )}
                                {unit.notes && (<div className="mt-4"><h4 className="text-lg font-bold text-gray-800 mb-2">Notes:</h4><p className="text-gray-700 whitespace-pre-wrap p-3 bg-gray-50 rounded border">{unit.notes}</p></div>)}
                                {unit.images.length > 0 && <h4 className="text-lg font-bold text-gray-800 mt-4 mb-2">Maintenance Photos</h4>}
                                <div className="grid grid-cols-2 gap-4">{unit.images.map((image, index) => (<div key={index} className="break-inside-avoid"><img src={image} alt={`Unit Photo ${index + 1}`} className="rounded-lg shadow-md w-full" /></div>))}</div>
                            </div>
                        </div>
                    ))}
                    <footer className="text-center mt-12 pt-8 border-t-2 border-gray-300">
                        <div className="grid grid-cols-2 gap-8">
                            <div className="text-left"><p className="font-semibold">Technician Name:</p><div className="border-b mt-8"></div></div>
                            <div className="text-left"><p className="font-semibold">Signature:</p><div className="border-b mt-8"></div></div>
                        </div>
                        <p className="text-sm text-gray-500 mt-8">Thank you for your business.</p>
                    </footer>
                </div>
            );
        };

        // Main App Component
        function App() {
            const [units, setUnits] = useState([]);
            const [clientInfo, setClientInfo] = useState({ name: '', address: '', workOrderNumber: '' });
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const [showAbout, setShowAbout] = useState(false);
            const [pdfData, setPdfData] = useState(null); // Used to trigger PDF generation

            useEffect(() => {
                if (pdfData) {
                    setIsGeneratingPdf(true);
                    // Timeout allows the DOM to update with the new pdfData before capturing
                    setTimeout(() => {
                        const input = document.getElementById('service-report');
                        const { jsPDF } = window.jspdf;
                        html2canvas(input, { scale: 2, useCORS: true, allowTaint: true }).then(canvas => {
                            const imgData = canvas.toDataURL('image/png');
                            const pdf = new jsPDF('p', 'mm', 'a4');
                            const pdfWidth = pdf.internal.pageSize.getWidth();
                            const pdfHeight = pdf.internal.pageSize.getHeight();
                            const canvasWidth = canvas.width;
                            const canvasHeight = canvas.height;
                            const ratio = canvasWidth / canvasHeight;
                            const imgWidth = pdfWidth;
                            const imgHeight = imgWidth / ratio;
                            let heightLeft = imgHeight;
                            let position = 0;
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= pdfHeight;
                            while (heightLeft > 0) {
                                position = heightLeft - imgHeight;
                                pdf.addPage();
                                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                                heightLeft -= pdfHeight;
                            }
                            const fileName = pdfData.units.length > 1 ? 'HVAC-Service-Report.pdf' : `HVAC-Report-Unit-${pdfData.units[0].unitNumber || pdfData.units[0].id}.pdf`;
                            pdf.save(fileName);
                            setIsGeneratingPdf(false);
                            setPdfData(null); // Reset pdfData
                        }).catch(err => {
                            console.error("Error generating PDF", err);
                            setIsGeneratingPdf(false);
                            setPdfData(null);
                        });
                    }, 100);
                }
            }, [pdfData]);

            const addUnit = (unit) => {
                setUnits([...units, unit]);
            };

            const updateUnit = (id, updatedUnit) => {
                setUnits(units.map(unit => (unit.id === id ? updatedUnit : unit)));
            };

            const deleteUnit = (id) => {
                setUnits(units.filter(unit => unit.id !== id));
            };
            
            const handleClientInfoChange = (e) => {
                const { name, value } = e.target;
                setClientInfo(prev => ({...prev, [name]: value}));
            }

            const generateSingleUnitPdf = (unit) => {
                setPdfData({ clientInfo, units: [unit] });
            };

            const generateFullReportPdf = () => {
                setPdfData({ clientInfo, units });
            };

            return (
                <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                    <header className="text-center mb-10"><h1 className="text-4xl sm:text-5xl font-extrabold text-gray-800">HVAC Service Reporter</h1><p className="text-lg text-gray-600 mt-2">Easily document unit maintenance and generate PDF reports.</p></header>
                    <div className="bg-white p-6 rounded-xl shadow-lg mb-8 border border-gray-200"><button onClick={() => setShowAbout(!showAbout)} className="text-xl font-bold text-gray-800 w-full text-left flex justify-between items-center"><span>About This App</span><span className="transform transition-transform">{showAbout ? '▲' : '▼'}</span></button>{showAbout && (<div className="mt-4 space-y-2 text-gray-700"><p>This application helps HVAC technicians create detailed service reports directly in the field. All data is stored in your browser, and nothing is uploaded to a server.</p><h4 className="font-semibold pt-2">How to Use:</h4><ol className="list-decimal list-inside space-y-1"><li><strong>Client Information:</strong> Fill in the client's name, address, and work order number.</li><li><strong>Add Units:</strong> Use the "Add New HVAC Unit" form to enter details for each unit you service. You can add multiple filters, belts, photos, and notes for each one.</li><li><strong>Complete the Punch List:</strong> Check off each task as you complete it for the unit.</li><li><strong>Manage Units:</strong> After adding a unit, you can edit or delete it from the list.</li><li><strong>Generate Report:</strong> Once all units are documented, click the "Generate Full Service Report (PDF)" button to create and download a professional PDF report.</li></ol></div>)}</div>
                    <div className="bg-white p-8 rounded-xl shadow-2xl mb-8 border border-gray-200"><h2 className="text-2xl font-bold text-gray-800 mb-6">Client Information</h2><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" name="name" placeholder="Client Name" value={clientInfo.name} onChange={handleClientInfoChange} className="p-3 border rounded-lg" /><input type="text" name="address" placeholder="Client Address" value={clientInfo.address} onChange={handleClientInfoChange} className="p-3 border rounded-lg" /><input type="text" name="workOrderNumber" placeholder="Work Order #" value={clientInfo.workOrderNumber} onChange={handleClientInfoChange} className="p-3 border rounded-lg md:col-span-2" /></div></div>
                    <UnitForm onAddUnit={addUnit} />
                    <div className="my-10"><h2 className="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2">Service Units</h2>{units.length === 0 ? (<p className="text-center text-gray-500">No units added yet. Use the form above to add one.</p>) : (units.map(unit => (<UnitCard key={unit.id} unit={unit} onUpdate={updateUnit} onDelete={deleteUnit} onGeneratePdf={generateSingleUnitPdf} />)))}</div>
                    {units.length > 0 && (<div className="text-center my-10"><button onClick={generateFullReportPdf} disabled={isGeneratingPdf} className="bg-green-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-green-700 transition-all transform hover:scale-105 disabled:bg-gray-400">{isGeneratingPdf ? 'Generating PDF...' : 'Generate Full Service Report (PDF)'}</button></div>)}
                    <div className="absolute -left-full -top-full opacity-0"><ServiceReport units={pdfData ? pdfData.units : []} clientInfo={pdfData ? pdfData.clientInfo : clientInfo} /></div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>

</body>
</html>

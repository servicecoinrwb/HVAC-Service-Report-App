<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Service Report - Integrated</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase v8 (better compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Firebase Configuration - YOUR ACTUAL CONFIG IS CORRECTLY SET
        const firebaseConfig = {
            apiKey: "AIzaSyAlev0GFpv3rzRYCJaMALOqlPwaowNfynI",
            authDomain: "hvac-finance-dashboard.firebaseapp.com", 
            projectId: "hvac-finance-dashboard",
            storageBucket: "hvac-finance-dashboard.firebasestorage.app",
            messagingSenderId: "917610618621",
            appId: "1:917610618621:web:83c621d154c5f62c9be894"
        };

        // Initialize Firebase (v8 syntax)
        let db, auth;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization failed:', error);
        }

        // Company ID - YOUR FIREBASE AUTH UID
        const COMPANY_ID = 'uZAcGdtGAJYr2gZHh8JWicKfJO72';

        // --- PREDEFINED OPTIONS ---
        const hvacMakes = ["Carrier", "Goodman", "Trane", "Lennox", "York", "Rheem", "Ruud", "Amana", "Bryant", "Heil", "Payne", "Daikin", "Other"];
        const unitTypes = ["Rooftop Unit (RTU)", "Air Handling Unit (AHU)", "Split System", "Furnace", "Boiler", "Heat Pump", "Ductless Mini-Split", "EF Exhaust Fan", "VAV Variable Air Volume", "Other"];
        const locations = ["Rooftop", "Basement", "Mechanical Room", "Closet", "Attic", "Exterior Wall", "Crawlspace", "Other"];
        const areasServed = ["First Floor", "Second Floor", "Office Area", "Warehouse", "Lobby", "Conference Room", "Server Room", "Kitchen", "Whole Building", "Other"];
        const unitNumbers = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "N/A"];
        const filterSizes = ["16x20x1", "16x25x1", "20x20x1", "20x25x1", "20x20x2", "20x25x2", "24x24x2", "Custom"];
        const beltSizes = ["AX-34", "AX-35", "AX-36", "BX-45", "BX-46", "BX-47", "4L350", "4L360", "4L370", "Custom"];
        const punchListItems = [
            "Fill out HVAC Survery Sheet In Full: Make, Model, Serial, Age, Tonnage, Area Served, and Condition",
            "Replace air filters",
            "Clean condensate drain",
            "Lubricate blower shaft bearings",
            "Inspect belts",
            "Check refrigerant charge",
            "Check program and thermostat operation",
            "Check evaporator and condenser coils",
            "Inspect blower motor mounts",
            "Lubricate blower motor bearings",
            "Lubricate evaporator / fan motor",
            "Test high/low pressure control operation"
        ];

        // --- DATA SERVICE ---
        const DataService = {
            getCurrentTechnician: () => {
                try {
                    const techData = JSON.parse(localStorage.getItem('currentTechnician') || '{}');
                    if (!techData.id) {
                        throw new Error('No technician data found');
                    }
                    return techData;
                } catch {
                    throw new Error('Invalid technician data');
                }
            },
            
            loadAssignedWorkOrders: async () => {
                if (!db) throw new Error('Firebase not initialized');
                if (!COMPANY_ID) throw new Error('Company ID not configured');
                
                try {
                    const tech = DataService.getCurrentTechnician();
                    
                    const snapshot = await db.collection('artifacts')
                        .doc('workOrderManagement')
                        .collection('users')
                        .doc(COMPANY_ID)
                        .collection('workOrders')
                        .where('technician', 'array-contains', tech.id)
                        .where('Order Status', 'in', ['Open', 'Scheduled', 'In Progress'])
                        .get();
                    
                    const workOrders = [];
                    snapshot.forEach(doc => {
                        workOrders.push({ id: doc.id, ...doc.data() });
                    });
                    return workOrders;
                } catch (error) {
                    console.error('Error loading work orders:', error);
                    throw new Error('Failed to load work orders: ' + error.message);
                }
            },

            syncServiceReport: async (units, clientInfo, workOrderId = null) => {
                if (!db) throw new Error('Firebase not initialized');
                if (!COMPANY_ID) throw new Error('Company ID not configured');
                
                try {
                    const tech = DataService.getCurrentTechnician();
                    
                    const reportData = {
                        technicianId: tech.id,
                        technicianName: tech.name,
                        technicianEmail: tech.email,
                        clientInfo,
                        units,
                        completedAt: new Date().toISOString(),
                        startTime: new Date().toISOString(),
                        workOrderId,
                        status: 'completed'
                    };
                    
                    const reportRef = await db.collection('artifacts')
                        .doc('workOrderManagement')
                        .collection('users')
                        .doc(COMPANY_ID)
                        .collection('serviceReports')
                        .add(reportData);
                    
                    if (workOrderId) {
                        await db.collection('artifacts')
                            .doc('workOrderManagement')
                            .collection('users')
                            .doc(COMPANY_ID)
                            .collection('workOrders')
                            .doc(workOrderId)
                            .update({
                                'Order Status': 'Completed',
                                'Completion Date': new Date().toISOString(),
                                serviceReportId: reportRef.id,
                                lastUpdated: new Date().toISOString()
                            });
                    }
                    
                    return reportRef.id;
                } catch (error) {
                    console.error('Sync failed:', error);
                    // Store for offline sync
                    const pendingReports = JSON.parse(localStorage.getItem('pendingReports') || '[]');
                    pendingReports.push({ units, clientInfo, workOrderId, timestamp: Date.now() });
                    localStorage.setItem('pendingReports', JSON.stringify(pendingReports));
                    throw new Error('Sync failed: ' + error.message);
                }
            },

            retryPendingSync: async () => {
                const pendingReports = JSON.parse(localStorage.getItem('pendingReports') || '[]');
                if (pendingReports.length === 0) return 0;
                
                let syncedCount = 0;
                const failedReports = [];
                
                for (const report of pendingReports) {
                    try {
                        await DataService.syncServiceReport(report.units, report.clientInfo, report.workOrderId);
                        syncedCount++;
                    } catch (error) {
                        console.error('Retry sync failed for report:', error);
                        failedReports.push(report);
                    }
                }
                
                localStorage.setItem('pendingReports', JSON.stringify(failedReports));
                return syncedCount;
            }
        };

        // Helper to convert file to base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- LOGIN COMPONENT ---
        const LoginForm = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!auth) {
                    setError('Firebase authentication not available. Check your configuration.');
                    return;
                }
                
                if (!COMPANY_ID) {
                    setError('Company ID not configured. Contact your administrator.');
                    return;
                }
                
                setLoading(true);
                setError('');
                
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // Check if user is the company owner (management access)
                    if (user.uid === COMPANY_ID) {
                        localStorage.setItem('currentTechnician', JSON.stringify({
                            id: user.uid,
                            name: 'Management',
                            email: user.email,
                            companyId: COMPANY_ID,
                            isOwner: true
                        }));
                        onLogin({ name: 'Management', email: user.email, isOwner: true });
                        return;
                    }
                    
                    // Check if user is a technician
                    const techDoc = await db.collection('artifacts')
                        .doc('workOrderManagement')
                        .collection('users')
                        .doc(COMPANY_ID)
                        .collection('technicians')
                        .doc(user.uid)
                        .get();
                    
                    if (techDoc.exists) {
                        const techData = techDoc.data();
                        localStorage.setItem('currentTechnician', JSON.stringify({
                            id: user.uid,
                            name: techData.name,
                            email: techData.email,
                            companyId: COMPANY_ID,
                            isOwner: false
                        }));
                        onLogin(techData);
                    } else {
                        throw new Error('Access denied - technician account required');
                    }
                } catch (error) {
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50">
                    <div className="max-w-md w-full space-y-8 p-8 bg-white rounded-lg shadow">
                        <div>
                            <h2 className="text-center text-3xl font-bold text-gray-900">Technician Login</h2>
                            <p className="text-center text-sm text-gray-600 mt-2">HVAC Service Reporter</p>
                        </div>
                        <form onSubmit={handleLogin} className="mt-8 space-y-6">
                            <input
                                type="email"
                                required
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                placeholder="Email address"
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
                            />
                            <input
                                type="password"
                                required
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                placeholder="Password"
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500"
                            />
                            {error && <div className="text-red-600 text-sm">{error}</div>}
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400"
                            >
                                {loading ? 'Signing in...' : 'Sign In'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- WORK ORDER SELECTOR ---
        const WorkOrderSelector = ({ selectedWorkOrder, onSelectWorkOrder, onClearSelection }) => {
            const [loading, setLoading] = useState(true);
            const [orders, setOrders] = useState([]);
            const [error, setError] = useState('');

            useEffect(() => {
                const loadOrders = async () => {
                    setLoading(true);
                    setError('');
                    try {
                        const loadedOrders = await DataService.loadAssignedWorkOrders();
                        setOrders(loadedOrders);
                    } catch (err) {
                        setError('Failed to load work orders: ' + err.message);
                    } finally {
                        setLoading(false);
                    }
                };
                loadOrders();
            }, []);

            return (
                <div className="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 className="text-xl font-bold mb-4">Assigned Work Orders</h3>
                    {selectedWorkOrder ? (
                        <div className="p-4 bg-blue-50 rounded-lg">
                            <div className="flex justify-between items-start">
                                <div>
                                    <h4 className="font-bold text-blue-900">WO# {selectedWorkOrder['Work Order #'] || selectedWorkOrder['WO#']}</h4>
                                    <p className="text-blue-700">Client: {selectedWorkOrder.Client}</p>
                                    <p className="text-blue-700">Address: {selectedWorkOrder.Address || selectedWorkOrder.Company}</p>
                                    <p className="text-sm text-blue-600">Task: {selectedWorkOrder.Task}</p>
                                </div>
                                <button 
                                    onClick={onClearSelection}
                                    className="text-blue-600 hover:text-blue-800"
                                >
                                    Change Work Order
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-2">
                            {loading ? (
                                <p className="text-gray-500">Loading work orders...</p>
                            ) : error ? (
                                <p className="text-red-600">{error}</p>
                            ) : orders.length === 0 ? (
                                <p className="text-gray-500">No assigned work orders found. You can still create service reports manually.</p>
                            ) : (
                                orders.map(order => (
                                    <div key={order.id} 
                                         onClick={() => onSelectWorkOrder(order)}
                                         className="p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                        <div className="flex justify-between items-center">
                                            <div>
                                                <h4 className="font-semibold">WO# {order['Work Order #'] || order['WO#']}</h4>
                                                <p className="text-sm text-gray-600">{order.Client} - {order.Task}</p>
                                                <p className="text-xs text-gray-500">Priority: {order.Priority} | Status: {order['Order Status']}</p>
                                            </div>
                                            <span className="text-blue-600">Select â†’</span>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- SYNC STATUS COMPONENT ---
        const SyncStatus = ({ onRetrySync, syncCount }) => {
            const [pendingCount, setPendingCount] = useState(0);
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                const updatePendingCount = () => {
                    const pending = JSON.parse(localStorage.getItem('pendingReports') || '[]');
                    setPendingCount(pending.length);
                };
                
                updatePendingCount();
                
                const handleOnlineStatus = () => {
                    setIsOnline(navigator.onLine);
                    if (navigator.onLine) {
                        onRetrySync();
                    }
                };

                window.addEventListener('online', handleOnlineStatus);
                window.addEventListener('offline', handleOnlineStatus);
                window.addEventListener('storage', updatePendingCount);
                
                return () => {
                    window.removeEventListener('online', handleOnlineStatus);
                    window.removeEventListener('offline', handleOnlineStatus);
                    window.removeEventListener('storage', updatePendingCount);
                };
            }, [onRetrySync]);

            if (pendingCount === 0 && isOnline) return null;

            return (
                <div className={`p-4 rounded-lg mb-4 ${isOnline ? 'bg-yellow-50 border border-yellow-200' : 'bg-red-50 border border-red-200'}`}>
                    <div className="flex justify-between items-center">
                        <div>
                            <p className={`font-semibold ${isOnline ? 'text-yellow-800' : 'text-red-800'}`}>
                                {isOnline ? 'Sync Status' : 'Offline Mode'}
                            </p>
                            {pendingCount > 0 && (
                                <p className={`text-sm ${isOnline ? 'text-yellow-600' : 'text-red-600'}`}>
                                    {pendingCount} report(s) pending sync
                                </p>
                            )}
                            {syncCount > 0 && (
                                <p className="text-sm text-green-600">
                                    Recently synced {syncCount} report(s)
                                </p>
                            )}
                        </div>
                        {isOnline && pendingCount > 0 && (
                            <button 
                                onClick={onRetrySync}
                                className="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700"
                            >
                                Retry Sync
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        // --- UNIT FORM ---
        const UnitForm = ({ onAddUnit, selectedWorkOrder }) => {
            const [unitNumber, setUnitNumber] = useState('');
            const [unitType, setUnitType] = useState('');
            const [location, setLocation] = useState('');
            const [areaServed, setAreaServed] = useState('');
            const [make, setMake] = useState('');
            const [modelNumber, setModelNumber] = useState('');
            const [serialNumber, setSerialNumber] = useState('');
            const [notes, setNotes] = useState('');
            const [images, setImages] = useState([]);
            const [filters, setFilters] = useState([{ size: '', quantity: '' }]);
            const [belts, setBelts] = useState([{ size: '', quantity: '' }]);
            const [punchList, setPunchList] = useState(() => punchListItems.reduce((acc, item) => ({...acc, [item]: false }), {}));
            const [driveType, setDriveType] = useState('belt');
            const [economizer, setEconomizer] = useState('no');
            const fileInputRef = useRef(null);
            const cameraInputRef = useRef(null);

            const handleImageUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                const base64Images = await Promise.all(files.map(file => toBase64(file)));
                setImages(prevImages => [...prevImages, ...base64Images]);
            };

            const handleFilterChange = (index, event) => {
                const { name, value } = event.target;
                const newFilters = [...filters];
                newFilters[index][name] = value;
                setFilters(newFilters);
            };

            const handleBeltChange = (index, event) => {
                const { name, value } = event.target;
                const newBelts = [...belts];
                newBelts[index][name] = value;
                setBelts(newBelts);
            };

            const handlePunchListChange = (item) => {
                setPunchList(prev => ({ ...prev, [item]: !prev[item] }));
            };

            const handleToggleAllPunchList = () => {
                const allChecked = punchListItems.every(item => punchList[item]);
                const newPunchList = {};
                punchListItems.forEach(item => {
                    newPunchList[item] = !allChecked;
                });
                setPunchList(newPunchList);
            };

            const addFilterField = () => {
                setFilters([...filters, { size: '', quantity: '' }]);
            };
            
            const addBeltField = () => {
                setBelts([...belts, { size: '', quantity: '' }]);
            };

            const removeFilterField = (index) => {
                const newFilters = [...filters];
                newFilters.splice(index, 1);
                setFilters(newFilters);
            };
            
            const removeBeltField = (index) => {
                const newBelts = [...belts];
                newBelts.splice(index, 1);
                setBelts(newBelts);
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!location) {
                    alert("Please provide a location for the unit.");
                    return;
                }
                const finalFilters = filters.filter(f => f.size && f.quantity);
                const finalBelts = belts.filter(b => b.size && b.quantity);
                onAddUnit({ 
                    id: Date.now(), 
                    unitNumber, 
                    unitType, 
                    location, 
                    areaServed, 
                    make, 
                    modelNumber, 
                    serialNumber, 
                    images, 
                    filters: finalFilters, 
                    belts: finalBelts, 
                    driveType, 
                    economizer: economizer === 'yes', 
                    notes, 
                    punchList 
                });
                
                // Reset form
                setUnitNumber(''); setUnitType(''); setLocation(''); setAreaServed(''); setMake(''); 
                setModelNumber(''); setSerialNumber(''); setNotes(''); setImages([]); 
                setFilters([{ size: '', quantity: '' }]); setBelts([{ size: '', quantity: '' }]); 
                setDriveType('belt'); setEconomizer('no'); 
                setPunchList(punchListItems.reduce((acc, item) => ({...acc, [item]: false }), {}));
            };
            
            const handleRemoveImage = (index) => {
                setImages(images.filter((_, i) => i !== index));
            };

            return (
                <div className="bg-white p-8 rounded-xl shadow-2xl mb-8 border border-gray-200">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Add New HVAC Unit</h2>
                    
                    {selectedWorkOrder && (
                        <div className="mb-4 p-3 bg-blue-50 rounded-lg">
                            <p className="text-sm text-blue-700">
                                Adding unit for Work Order: <strong>{selectedWorkOrder['Work Order #'] || selectedWorkOrder['WO#']}</strong>
                            </p>
                            {selectedWorkOrder.servicedAssets && selectedWorkOrder.servicedAssets.length > 0 && (
                                <div className="mt-2">
                                    <p className="text-xs text-blue-600">Expected assets:</p>
                                    <ul className="text-xs text-blue-600 list-disc list-inside ml-2">
                                        {selectedWorkOrder.servicedAssets.map((asset, index) => (
                                            <li key={index}>{asset}</li>
                                        ))}
                                    </ul>
                                </div>
                            )}
                        </div>
                    )}
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <select value={unitNumber} onChange={(e) => setUnitNumber(e.target.value)} className="p-3 border rounded-lg">
                                <option value="">Select Unit Number</option>
                                {unitNumbers.map(n => <option key={n} value={n}>{n}</option>)}
                            </select>
                            <select value={unitType} onChange={(e) => setUnitType(e.target.value)} className="p-3 border rounded-lg">
                                <option value="">Select Unit Type</option>
                                {unitTypes.map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                            <select value={location} onChange={(e) => setLocation(e.target.value)} className="p-3 border rounded-lg" required>
                                <option value="">Select Location</option>
                                {locations.map(l => <option key={l} value={l}>{l}</option>)}
                            </select>
                            <select value={areaServed} onChange={(e) => setAreaServed(e.target.value)} className="p-3 border rounded-lg">
                                <option value="">Select Area Served</option>
                                {areasServed.map(a => <option key={a} value={a}>{a}</option>)}
                            </select>
                            <select value={make} onChange={(e) => setMake(e.target.value)} className="p-3 border rounded-lg">
                                <option value="">Select Make</option>
                                {hvacMakes.map(m => <option key={m} value={m}>{m}</option>)}
                            </select>
                            <input type="text" placeholder="Model Number" value={modelNumber} onChange={(e) => setModelNumber(e.target.value)} className="p-3 border rounded-lg" />
                            <input type="text" placeholder="Serial Number" value={serialNumber} onChange={(e) => setSerialNumber(e.target.value)} className="p-3 border rounded-lg" />
                        </div>
                        <textarea placeholder="Notes about the unit..." value={notes} onChange={(e) => setNotes(e.target.value)} className="p-3 border rounded-lg w-full h-28"></textarea>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <select value={driveType} onChange={(e) => setDriveType(e.target.value)} className="p-3 border rounded-lg">
                                <option value="belt">Belt Drive</option>
                                <option value="dd">Direct Drive</option>
                            </select>
                            <div className="flex items-center space-x-4 p-3">
                                <label className="font-medium">Economizer:</label>
                                <label><input type="radio" value="yes" checked={economizer === 'yes'} onChange={(e) => setEconomizer(e.target.value)} className="mr-1"/>Yes</label>
                                <label><input type="radio" value="no" checked={economizer === 'no'} onChange={(e) => setEconomizer(e.target.value)} className="mr-1"/>No</label>
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Filters</label>
                            {filters.map((filter, index) => (
                                <div key={index} className="flex items-center space-x-2 mb-2">
                                    <input list="filter-sizes" name="size" value={filter.size} onChange={e => handleFilterChange(index, e)} placeholder="Filter Size (e.g., 20x20x1)" className="p-3 border rounded-lg w-full md:w-1/2" />
                                    <input type="number" name="quantity" value={filter.quantity} onChange={e => handleFilterChange(index, e)} placeholder="Qty" className="p-3 border rounded-lg w-full md:w-1/4" />
                                    <button type="button" onClick={() => removeFilterField(index)} className="px-3 py-2 bg-red-200 text-red-800 rounded-lg hover:bg-red-300">-</button>
                                </div>
                            ))}
                            <datalist id="filter-sizes">{filterSizes.map(s => <option key={s} value={s}/>)}</datalist>
                            <button type="button" onClick={addFilterField} className="mt-1 text-sm text-blue-600 hover:underline">+ Add another filter size</button>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Belts</label>
                            {belts.map((belt, index) => (
                                <div key={index} className="flex items-center space-x-2 mb-2">
                                    <input list="belt-sizes" name="size" value={belt.size} onChange={e => handleBeltChange(index, e)} placeholder="Belt Size (e.g., AX-34)" className="p-3 border rounded-lg w-full md:w-1/2" />
                                    <input type="number" name="quantity" value={belt.quantity} onChange={e => handleBeltChange(index, e)} placeholder="Qty" className="p-3 border rounded-lg w-full md:w-1/4" />
                                    <button type="button" onClick={() => removeBeltField(index)} className="px-3 py-2 bg-red-200 text-red-800 rounded-lg hover:bg-red-300">-</button>
                                </div>
                            ))}
                            <datalist id="belt-sizes">{beltSizes.map(s => <option key={s} value={s}/>)}</datalist>
                            <button type="button" onClick={addBeltField} className="mt-1 text-sm text-blue-600 hover:underline">+ Add another belt size</button>
                        </div>
                        <div>
                            <div className="flex justify-between items-center mb-2">
                                <label className="block text-lg font-medium text-gray-700">Punch List</label>
                                <button type="button" onClick={handleToggleAllPunchList} className="text-sm text-blue-600 hover:underline">
                                    {punchListItems.every(item => punchList[item]) ? 'Uncheck All' : 'Check All'}
                                </button>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2">
                                {punchListItems.map((item, index) => (
                                    <label key={index} className="flex items-center space-x-3">
                                        <input type="checkbox" checked={punchList[item]} onChange={() => handlePunchListChange(item)} className="h-4 w-4"/>
                                        <span className="text-gray-700">{item}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <button type="button" onClick={() => fileInputRef.current.click()} className="w-full px-4 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Upload Pictures</button>
                            <button type="button" onClick={() => cameraInputRef.current.click()} className="w-full px-4 py-3 bg-blue-200 text-blue-800 rounded-lg hover:bg-blue-300 transition">Open Camera</button>
                            <input type="file" multiple accept="image/*" ref={fileInputRef} className="hidden" onChange={handleImageUpload} />
                            <input type="file" accept="image/*" capture="environment" ref={cameraInputRef} className="hidden" onChange={handleImageUpload} />
                        </div>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            {images.map((image, index) => (
                                <div key={index} className="relative">
                                    <img src={image} alt={`upload-preview ${index}`} className="rounded-md object-cover w-full h-32" />
                                    <button type="button" onClick={() => handleRemoveImage(index)} className="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 text-xs leading-none">&times;</button>
                                </div>
                            ))}
                        </div>
                        <button type="submit" className="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Add Unit</button>
                    </form>
                </div>
            );
        };

        // --- UNIT CARD (Original functionality maintained) ---
        const UnitCard = ({ unit, onUpdate, onDelete, onGeneratePdf }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editedUnit, setEditedUnit] = useState(unit);
            const fileInputRef = useRef(null);
            const cameraInputRef = useRef(null);

            const handleImageUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                const base64Images = await Promise.all(files.map(file => toBase64(file)));
                const newImages = [...editedUnit.images, ...base64Images];
                const updatedUnit = { ...editedUnit, images: newImages };
                setEditedUnit(updatedUnit);
                onUpdate(updatedUnit.id, updatedUnit);
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setEditedUnit({ ...editedUnit, [name]: value });
            };
            
            const handlePunchListChange = (item) => {
                setEditedUnit(prev => ({
                    ...prev,
                    punchList: {
                        ...prev.punchList,
                        [item]: !prev.punchList[item]
                    }
                }));
            };

            const handleToggleAllPunchList = () => {
                const allChecked = punchListItems.every(item => editedUnit.punchList[item]);
                const newPunchList = {};
                punchListItems.forEach(item => {
                    newPunchList[item] = !allChecked;
                });
                setEditedUnit(prev => ({ ...prev, punchList: newPunchList }));
            };

            const handleEconomizerChange = (e) => {
                setEditedUnit({ ...editedUnit, economizer: e.target.value === 'yes' });
            };
            
            const handleFilterChange = (index, event) => {
                const { name, value } = event.target;
                const newFilters = [...editedUnit.filters];
                newFilters[index][name] = value;
                setEditedUnit({ ...editedUnit, filters: newFilters });
            };
            
            const handleBeltChange = (index, event) => {
                const { name, value } = event.target;
                const newBelts = [...editedUnit.belts];
                newBelts[index][name] = value;
                setEditedUnit({ ...editedUnit, belts: newBelts });
            };

            const addFilterField = () => {
                const newFilters = [...(editedUnit.filters || []), { size: '', quantity: '' }];
                setEditedUnit({ ...editedUnit, filters: newFilters });
            };

            const addBeltField = () => {
                const newBelts = [...(editedUnit.belts || []), { size: '', quantity: '' }];
                setEditedUnit({ ...editedUnit, belts: newBelts });
            };

            const removeFilterField = (index) => {
                const newFilters = [...editedUnit.filters];
                newFilters.splice(index, 1);
                setEditedUnit({ ...editedUnit, filters: newFilters });
            };
            
            const removeBeltField = (index) => {
                const newBelts = [...editedUnit.belts];
                newBelts.splice(index, 1);
                setEditedUnit({ ...editedUnit, belts: newBelts });
            };

            const handleSaveChanges = () => {
                const finalFilters = editedUnit.filters ? editedUnit.filters.filter(f => f.size && f.quantity) : [];
                const finalBelts = editedUnit.belts ? editedUnit.belts.filter(b => b.size && b.quantity) : [];
                onUpdate(editedUnit.id, {...editedUnit, filters: finalFilters, belts: finalBelts});
                setIsEditing(false);
            };

            const handleRemoveImage = (index) => {
                const newImages = editedUnit.images.filter((_, i) => i !== index);
                const updatedUnit = { ...editedUnit, images: newImages };
                setEditedUnit(updatedUnit);
                onUpdate(updatedUnit.id, updatedUnit);
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-lg mb-6 border border-gray-200">
                    {!isEditing ? (
                        <div>
                            <h3 className="text-xl font-bold text-gray-800 mb-4">Unit #{unit.unitNumber || 'N/A'}: {unit.location}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                                <p><strong className="font-semibold">Make:</strong> {unit.make}</p>
                                <p><strong className="font-semibold">Unit Type:</strong> {unit.unitType}</p>
                                <p><strong className="font-semibold">Area Served:</strong> {unit.areaServed}</p>
                                <p><strong className="font-semibold">Model #:</strong> {unit.modelNumber}</p>
                                <p><strong className="font-semibold">Serial #:</strong> {unit.serialNumber}</p>
                                <p><strong className="font-semibold">Drive Type:</strong> {unit.driveType === 'dd' ? 'Direct Drive' : 'Belt Drive'}</p>
                                <p><strong className="font-semibold">Economizer:</strong> {unit.economizer ? 'Yes' : 'No'}</p>
                            </div>
                            {unit.filters && unit.filters.length > 0 && (
                                <div className="mt-4">
                                    <h4 className="font-semibold text-gray-700">Filters:</h4>
                                    <ul className="list-disc list-inside ml-4">{unit.filters.map((filter, index) => (<li key={index}>{filter.quantity}x - {filter.size}</li>))}</ul>
                                </div>
                            )}
                            {unit.belts && unit.belts.length > 0 && (
                                <div className="mt-4">
                                    <h4 className="font-semibold text-gray-700">Belts:</h4>
                                    <ul className="list-disc list-inside ml-4">{unit.belts.map((belt, index) => (<li key={index}>{belt.quantity}x - {belt.size}</li>))}</ul>
                                </div>
                            )}
                            {unit.punchList && Object.values(unit.punchList).some(v => v) && (
                                <div className="mt-4">
                                    <h4 className="font-semibold text-gray-700">Punch List Completed:</h4>
                                    <ul className="list-disc list-inside ml-4">{punchListItems.map((item, index) => (unit.punchList[item] && <li key={index}>{item}</li>))}</ul>
                                </div>
                            )}
                             {unit.notes && (<div className="mt-4"><h4 className="font-semibold text-gray-700">Notes:</h4><p className="text-gray-600 whitespace-pre-wrap bg-gray-50 p-3 rounded-md">{unit.notes}</p></div>)}
                            <div className="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">{unit.images.map((image, index) => (<div key={index} className="relative"><img src={image} alt={`Unit ${index + 1}`} className="rounded-md object-cover w-full h-32" /></div>))}</div>
                            <div className="mt-6 flex justify-end space-x-3">
                                <button onClick={() => onGeneratePdf(unit)} className="px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600 transition">Generate Unit PDF</button>
                                <button onClick={() => setIsEditing(true)} className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">Edit</button>
                                <button onClick={() => onDelete(unit.id)} className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition">Delete</button>
                            </div>
                        </div>
                    ) : (
                        <div>
                            <h3 className="text-xl font-bold text-gray-800 mb-4">Editing Unit</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <select name="unitNumber" value={editedUnit.unitNumber} onChange={handleInputChange} className="p-2 border rounded-md"><option value="">Unit Number</option>{unitNumbers.map(n => <option key={n} value={n}>{n}</option>)}</select>
                                <select name="unitType" value={editedUnit.unitType} onChange={handleInputChange} className="p-2 border rounded-md"><option value="">Unit Type</option>{unitTypes.map(t => <option key={t} value={t}>{t}</option>)}</select>
                                <select name="location" value={editedUnit.location} onChange={handleInputChange} className="p-2 border rounded-md"><option value="">Location</option>{locations.map(l => <option key={l} value={l}>{l}</option>)}</select>
                                <select name="areaServed" value={editedUnit.areaServed} onChange={handleInputChange} className="p-2 border rounded-md"><option value="">Area Served</option>{areasServed.map(a => <option key={a} value={a}>{a}</option>)}</select>
                                <select name="make" value={editedUnit.make} onChange={handleInputChange} className="p-2 border rounded-md"><option value="">Make</option>{hvacMakes.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                <input type="text" name="modelNumber" value={editedUnit.modelNumber} onChange={handleInputChange} placeholder="Model Number" className="p-2 border rounded-md" />
                                <input type="text" name="serialNumber" value={editedUnit.serialNumber} onChange={handleInputChange} placeholder="Serial Number" className="p-2 border rounded-md" />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <select name="driveType" value={editedUnit.driveType} onChange={handleInputChange} className="p-2 border rounded-md"><option value="belt">Belt Drive</option><option value="dd">Direct Drive</option></select>
                                <div className="flex items-center space-x-4"><label className="font-medium">Economizer:</label><label><input type="radio" value="yes" checked={editedUnit.economizer === true} onChange={handleEconomizerChange} className="mr-1"/>Yes</label><label><input type="radio" value="no" checked={editedUnit.economizer === false} onChange={handleEconomizerChange} className="mr-1"/>No</label></div>
                            </div>
                            <div className="mt-4">
                                <h4 className="font-semibold text-gray-700 mb-2">Filters</h4>
                                {editedUnit.filters.map((filter, index) => (
                                    <div key={index} className="flex items-center space-x-2 mb-2">
                                        <input list="filter-sizes" name="size" value={filter.size} onChange={e => handleFilterChange(index, e)} placeholder="Filter Size" className="p-2 border rounded-md w-1/2" />
                                        <datalist id="filter-sizes">{filterSizes.map(s => <option key={s} value={s}/>)}</datalist>
                                        <input type="number" name="quantity" value={filter.quantity} onChange={e => handleFilterChange(index, e)} placeholder="Qty" className="p-2 border rounded-md w-1/4" />
                                        <button onClick={() => removeFilterField(index)} className="px-3 py-2 bg-red-500 text-white rounded-md">&times;</button>
                                    </div>
                                ))}
                                <button onClick={addFilterField} className="text-sm text-blue-500 hover:underline">+ Add Filter</button>
                            </div>
                             <div className="mt-4">
                                <h4 className="font-semibold text-gray-700 mb-2">Belts</h4>
                                {editedUnit.belts.map((belt, index) => (
                                    <div key={index} className="flex items-center space-x-2 mb-2">
                                        <input list="belt-sizes" name="size" value={belt.size} onChange={e => handleBeltChange(index, e)} placeholder="Belt Size" className="p-2 border rounded-md w-1/2" />
                                        <datalist id="belt-sizes">{beltSizes.map(s => <option key={s} value={s}/>)}</datalist>
                                        <input type="number" name="quantity" value={belt.quantity} onChange={e => handleBeltChange(index, e)} placeholder="Qty" className="p-2 border rounded-md w-1/4" />
                                        <button onClick={() => removeBeltField(index)} className="px-3 py-2 bg-red-500 text-white rounded-md">&times;</button>
                                    </div>
                                ))}
                                <button onClick={addBeltField} className="text-sm text-blue-500 hover:underline">+ Add Belt</button>
                            </div>
                            <div className="mt-4">
                                <div className="flex justify-between items-center mb-2">
                                    <h4 className="font-semibold text-gray-700">Punch List</h4>
                                    <button type="button" onClick={handleToggleAllPunchList} className="text-sm text-blue-500 hover:underline">
                                        {punchListItems.every(item => editedUnit.punchList[item]) ? 'Uncheck All' : 'Check All'}
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                    {punchListItems.map((item, index) => (
                                        <label key={index} className="flex items-center space-x-2">
                                            <input type="checkbox" checked={!!editedUnit.punchList[item]} onChange={() => handlePunchListChange(item)} />
                                            <span>{item}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                            <div className="mt-4"><h4 className="font-semibold text-gray-700 mb-2">Notes</h4><textarea name="notes" value={editedUnit.notes} onChange={handleInputChange} placeholder="Service notes..." className="p-2 border rounded-md w-full h-24"></textarea></div>
                            <div className="mt-4 grid grid-cols-2 gap-2"><button onClick={() => fileInputRef.current.click()} className="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Upload Pictures</button><button onClick={() => cameraInputRef.current.click()} className="w-full px-4 py-2 bg-blue-200 text-blue-800 rounded-md hover:bg-blue-300 transition">Open Camera</button><input type="file" multiple accept="image/*" ref={fileInputRef} className="hidden" onChange={handleImageUpload} /><input type="file" accept="image/*" capture="environment" ref={cameraInputRef} className="hidden" onChange={handleImageUpload} /></div>
                            <div className="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">{editedUnit.images.map((image, index) => (<div key={index} className="relative"><img src={image} alt={`Unit ${index + 1}`} className="rounded-md object-cover w-full h-32" /><button onClick={() => handleRemoveImage(index)} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 text-xs">&times;</button></div>))}</div>
                            <div className="mt-6 flex justify-end"><button onClick={handleSaveChanges} className="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition">Save Changes</button></div>
                        </div>
                    )}
                </div>
            );
        };

        // --- SERVICE REPORT ---
        const ServiceReport = ({ units, clientInfo }) => {
            return (
                <div id="service-report" className="p-8 bg-white font-sans" style={{width: '210mm'}}>
                    <header className="flex justify-between items-start pb-4 border-b-2 border-blue-800">
                        <div>
                           <img src="https://lh3.googleusercontent.com/a/ACg8ocJV2x6I8rQLe7Z2reDr7C7mIOmtcnYBZ6SjSKGJVvX2td0b2-4Glw=s288-c-no" alt="Company Logo" className="h-20" />
                            <p className="text-md text-gray-600 mt-2">23093 Telegraph Rd, Southfield, MI 48033</p>
                        </div>
                        <div className="text-right">
                            <h1 className="text-4xl font-extrabold text-blue-800">Service Report</h1>
                            <p className="font-bold text-gray-700 mt-2">Date: <span className="font-normal">{new Date().toLocaleDateString()}</span></p>
                            <p className="font-bold text-gray-700">Work Order #: <span className="font-normal">{clientInfo.workOrderNumber || 'N/A'}</span></p>
                        </div>
                    </header>
                    <div className="my-6 p-4 bg-gray-50 rounded-lg border">
                        <h2 className="text-xl font-bold text-gray-800 mb-2 border-b pb-1">Client Information</h2>
                        <p className="font-semibold">{clientInfo.name}</p>
                        <p className="text-gray-700">{clientInfo.address}</p>
                    </div>
                    {units.map(unit => (
                        <div key={unit.id} className="mb-8 break-inside-avoid">
                            <h3 className="text-2xl font-bold text-white bg-blue-700 p-3 rounded-t-lg">Unit #{unit.unitNumber || 'N/A'}: {unit.unitType}</h3>
                            <div className="border-l border-r border-b p-4 rounded-b-lg">
                                <h4 className="text-lg font-bold text-gray-800 mb-2">Unit Details</h4>
                                <div className="grid grid-cols-2 gap-x-8 gap-y-2 mb-4 text-sm">
                                    <p><strong className="font-semibold text-gray-600">Make:</strong> {unit.make}</p>
                                    <p><strong className="font-semibold text-gray-600">Unit Type:</strong> {unit.unitType}</p>
                                    <p><strong className="font-semibold text-gray-600">Area Served:</strong> {unit.areaServed}</p>
                                    <p><strong className="font-semibold text-gray-600">Model #:</strong> {unit.modelNumber}</p>
                                    <p><strong className="font-semibold text-gray-600">Serial #:</strong> {unit.serialNumber}</p>
                                    <p><strong className="font-semibold text-gray-600">Location #:</strong> {unit.location}</p>
                                    <p><strong className="font-semibold text-gray-600">Drive Type:</strong> {unit.driveType === 'dd' ? 'Direct Drive' : 'Belt Drive'}</p>
                                    <p><strong className="font-semibold text-gray-600">Economizer:</strong> {unit.economizer ? 'Yes' : 'No'}</p>
                                </div>
                                <div className="grid grid-cols-2 gap-8">
                                    {unit.filters && unit.filters.length > 0 && (<div><h4 className="font-bold text-gray-800">Filters:</h4><ul className="list-disc list-inside ml-1">{unit.filters.map((filter, index) => (<li key={index}>{filter.quantity}x - {filter.size}</li>))}</ul></div>)}
                                    {unit.belts && unit.belts.length > 0 && (<div><h4 className="font-bold text-gray-800">Belts:</h4><ul className="list-disc list-inside ml-1">{unit.belts.map((belt, index) => (<li key={index}>{belt.quantity}x - {belt.size}</li>))}</ul></div>)}
                                </div>
                                {unit.punchList && Object.values(unit.punchList).some(v => v) && (
                                    <div className="mt-4"><h4 className="text-lg font-bold text-gray-800 mb-2">Punch List Completed:</h4>
                                    <ul className="grid grid-cols-2 gap-x-8 gap-y-1 text-sm">
                                        {punchListItems.map((item, index) => (unit.punchList[item] && <li key={index} className="flex items-center"><svg className="w-4 h-4 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd"></path></svg>{item}</li>))}
                                    </ul></div>
                                )}
                                {unit.notes && (<div className="mt-4"><h4 className="text-lg font-bold text-gray-800 mb-2">Notes:</h4><p className="text-gray-700 whitespace-pre-wrap p-3 bg-gray-50 rounded border">{unit.notes}</p></div>)}
                                {unit.images.length > 0 && <h4 className="text-lg font-bold text-gray-800 mt-4 mb-2">Maintenance Photos</h4>}
                                <div className="grid grid-cols-2 gap-4">{unit.images.map((image, index) => (<div key={index} className="break-inside-avoid"><img src={image} alt={`Unit Photo ${index + 1}`} className="rounded-lg shadow-md w-full" /></div>))}</div>
                            </div>
                        </div>
                    ))}
                    <footer className="text-center mt-12 pt-8 border-t-2 border-gray-300">
                        <div className="grid grid-cols-2 gap-8">
                            <div className="text-left"><p className="font-semibold">Technician Name:</p><div className="border-b mt-8"></div></div>
                            <div className="text-left"><p className="font-semibold">Signature:</p><div className="border-b mt-8"></div></div>
                        </div>
                        <p className="text-sm text-gray-500 mt-8">Thank you for your business.</p>
                    </footer>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [units, setUnits] = useState([]);
            const [selectedWorkOrder, setSelectedWorkOrder] = useState(null);
            const [clientInfo, setClientInfo] = useState({ name: '', address: '', workOrderNumber: '' });
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);
            const [showAbout, setShowAbout] = useState(false);
            const [pdfData, setPdfData] = useState(null);
            const [syncCount, setSyncCount] = useState(0);

            // Auto-populate client info when work order is selected
            useEffect(() => {
                if (selectedWorkOrder) {
                    setClientInfo({
                        name: selectedWorkOrder.Client || '',
                        address: selectedWorkOrder.Address || selectedWorkOrder.Company || '',
                        workOrderNumber: selectedWorkOrder['Work Order #'] || selectedWorkOrder['WO#'] || ''
                    });
                }
            }, [selectedWorkOrder]);

            // Check for existing login on app start
            useEffect(() => {
                const savedTech = localStorage.getItem('currentTechnician');
                if (savedTech) {
                    try {
                        const techData = JSON.parse(savedTech);
                        setUser(techData);
                    } catch (error) {
                        localStorage.removeItem('currentTechnician');
                    }
                }
            }, []);

            // PDF generation effect
            useEffect(() => {
                if (pdfData) {
                    setIsGeneratingPdf(true);
                    setTimeout(() => {
                        const input = document.getElementById('service-report');
                        const { jsPDF } = window.jspdf;
                        html2canvas(input, { scale: 2, useCORS: true, allowTaint: true }).then(canvas => {
                            const imgData = canvas.toDataURL('image/png');
                            const pdf = new jsPDF('p', 'mm', 'a4');
                            const pdfWidth = pdf.internal.pageSize.getWidth();
                            const pdfHeight = pdf.internal.pageSize.getHeight();
                            const canvasWidth = canvas.width;
                            const canvasHeight = canvas.height;
                            const ratio = canvasWidth / canvasHeight;
                            const imgWidth = pdfWidth;
                            const imgHeight = imgWidth / ratio;
                            let heightLeft = imgHeight;
                            let position = 0;
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= pdfHeight;
                            while (heightLeft > 0) {
                                position = heightLeft - imgHeight;
                                pdf.addPage();
                                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                                heightLeft -= pdfHeight;
                            }
                            const fileName = pdfData.units.length > 1 ? 'HVAC-Service-Report.pdf' : `HVAC-Report-Unit-${pdfData.units[0].unitNumber || pdfData.units[0].id}.pdf`;
                            pdf.save(fileName);
                            setIsGeneratingPdf(false);
                            setPdfData(null);
                        }).catch(err => {
                            console.error("Error generating PDF", err);
                            setIsGeneratingPdf(false);
                            setPdfData(null);
                        });
                    }, 100);
                }
            }, [pdfData]);

            const addUnit = (unit) => {
                setUnits([...units, unit]);
            };

            const updateUnit = (id, updatedUnit) => {
                setUnits(units.map(unit => (unit.id === id ? updatedUnit : unit)));
            };

            const deleteUnit = (id) => {
                setUnits(units.filter(unit => unit.id !== id));
            };
            
            const handleClientInfoChange = (e) => {
                const { name, value } = e.target;
                setClientInfo(prev => ({...prev, [name]: value}));
            };

            const generateSingleUnitPdf = (unit) => {
                setPdfData({ clientInfo, units: [unit] });
            };

            const handleGenerateReport = async () => {
                if (units.length === 0) {
                    alert('Please add at least one unit before generating a report.');
                    return;
                }

                setIsGeneratingPdf(true);
                try {
                    // Sync to business system
                    await DataService.syncServiceReport(
                        units, 
                        clientInfo, 
                        selectedWorkOrder?.id
                    );
                    
                    alert('Service report synced successfully!');
                    
                    // Generate PDF
                    setPdfData({ clientInfo, units });
                    
                } catch (error) {
                    console.error('Sync failed:', error);
                    alert('Sync failed - saved for retry when back online. PDF will still generate.');
                    // Still generate PDF even if sync fails
                    setPdfData({ clientInfo, units });
                } finally {
                    // PDF generation will set isGeneratingPdf to false
                }
            };

            const retryPendingSync = async () => {
                try {
                    const syncedCount = await DataService.retryPendingSync();
                    if (syncedCount > 0) {
                        setSyncCount(syncedCount);
                        setTimeout(() => setSyncCount(0), 5000); // Clear after 5 seconds
                    }
                } catch (error) {
                    console.error('Retry sync failed:', error);
                }
            };

            const handleLogout = () => {
                if (auth) {
                    auth.signOut();
                }
                localStorage.removeItem('currentTechnician');
                setUser(null);
                setUnits([]);
                setSelectedWorkOrder(null);
                setClientInfo({ name: '', address: '', workOrderNumber: '' });
            };

            if (!user) {
                return <LoginForm onLogin={setUser} />;
            }

            return (
                <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-4xl font-extrabold text-gray-800">HVAC Service Reporter</h1>
                            <p className="text-gray-600">Welcome, {user.name}</p>
                            {user.isOwner && <p className="text-sm text-blue-600">Management Access</p>}
                        </div>
                        <button 
                            onClick={handleLogout}
                            className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
                        >
                            Logout
                        </button>
                    </header>

                    <SyncStatus onRetrySync={retryPendingSync} syncCount={syncCount} />
                    
                    <WorkOrderSelector 
                        selectedWorkOrder={selectedWorkOrder}
                        onSelectWorkOrder={setSelectedWorkOrder}
                        onClearSelection={() => setSelectedWorkOrder(null)}
                    />

                    <div className="bg-white p-6 rounded-xl shadow-lg mb-8 border border-gray-200">
                        <button onClick={() => setShowAbout(!showAbout)} className="text-xl font-bold text-gray-800 w-full text-left flex justify-between items-center">
                            <span>About This App</span>
                            <span className="transform transition-transform">{showAbout ? 'â–²' : 'â–¼'}</span>
                        </button>
                        {showAbout && (
                            <div className="mt-4 space-y-2 text-gray-700">
                                <p>This application helps HVAC technicians create detailed service reports directly in the field and sync them with your business management system.</p>
                                <h4 className="font-semibold pt-2">Features:</h4>
                                <ul className="list-disc list-inside space-y-1">
                                    <li><strong>Work Order Integration:</strong> Select assigned work orders to auto-populate client information</li>
                                    <li><strong>Automatic Syncing:</strong> Service reports automatically sync to your business system</li>
                                    <li><strong>Offline Support:</strong> Work offline and sync when connection is restored</li>
                                    <li><strong>Secure Access:</strong> Login with your technician credentials for secure access</li>
                                    <li><strong>Professional PDF Reports:</strong> Generate detailed service reports with photos</li>
                                    <li><strong>Management Access:</strong> Business owners can access all features</li>
                                </ul>
                            </div>
                        )}
                    </div>
                    
                    {!selectedWorkOrder && (
                        <div className="bg-white p-8 rounded-xl shadow-2xl mb-8 border border-gray-200">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">Manual Service Report</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" name="name" placeholder="Client Name" value={clientInfo.name} onChange={handleClientInfoChange} className="p-3 border rounded-lg" />
                                <input type="text" name="address" placeholder="Client Address" value={clientInfo.address} onChange={handleClientInfoChange} className="p-3 border rounded-lg" />
                                <input type="text" name="workOrderNumber" placeholder="Work Order #" value={clientInfo.workOrderNumber} onChange={handleClientInfoChange} className="p-3 border rounded-lg md:col-span-2" />
                            </div>
                        </div>
                    )}

                    <UnitForm onAddUnit={addUnit} selectedWorkOrder={selectedWorkOrder} />
                    
                    <div className="my-10">
                        <h2 className="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2">Service Units</h2>
                        {units.length === 0 ? (
                            <p className="text-center text-gray-500">No units added yet. Use the form above to add one.</p>
                        ) : (
                            units.map(unit => (
                                <UnitCard 
                                    key={unit.id} 
                                    unit={unit} 
                                    onUpdate={updateUnit} 
                                    onDelete={deleteUnit} 
                                    onGeneratePdf={generateSingleUnitPdf} 
                                />
                            ))
                        )}
                    </div>
                    
                    {units.length > 0 && (
                        <div className="text-center my-10">
                            <button 
                                onClick={handleGenerateReport}
                                disabled={isGeneratingPdf}
                                className="bg-green-600 text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-green-700 transition-all transform hover:scale-105 disabled:bg-gray-400"
                            >
                                {isGeneratingPdf ? 'Generating & Syncing...' : 'Generate Service Report & Sync'}
                            </button>
                        </div>
                    )}
                    
                    <div className="absolute -left-full -top-full opacity-0">
                        <ServiceReport units={pdfData ? pdfData.units : []} clientInfo={pdfData ? pdfData.clientInfo : clientInfo} />
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>

</body>
</html>
